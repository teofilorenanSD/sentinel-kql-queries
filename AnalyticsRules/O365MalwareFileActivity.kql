// Name: Malware File Post Activity Investigation
// Description: Identifies user actions performed on files after malware detection in OneDrive and SharePoint.
// Data Source: OfficeActivity
// MITRE: T1204 (User Execution) - Potential follow-up investigation
// Author: Renan TeÃ³filo
// Version: 1.0

let timeRange = 7d;
let file_malware_detected = OfficeActivity 
| where TimeGenerated >= ago(timeRange)
| where OfficeWorkload in ("OneDrive", "SharePoint")
| where Operation == "FileMalwareDetected"
| project ListItemUniqueId; 
OfficeActivity
| where TimeGenerated >= ago(timeRange)
| where Operation != "FileMalwareDetected"
| where OfficeWorkload in ("OneDrive", "SharePoint")
| join kind=inner file_malware_detected on ListItemUniqueId
| project 
    Operation,
    SourceRelativeUrl,
    SourceFileName,
    SourceFileExtension,
    UserType,
    UserKey,
    OfficeWorkload,
    OfficeObjectId,
    UserId,
    ClientIP,
    ItemType,
    Site_Url
